\section{Laitossuunnitteluohjelmistoon optimoitu tietorakenne} \label{mun}

Tässä luvussa esitellään pistepilvien käsittelyyn ja visualisointiin soveltuva tietorakenne ja algoritmeja erityisesti laitossuunnitteluohjelmiston tarpeisiin. Ensin määritellään vaatimukset tietorakenteelle tyypillisten pistepilvien käyttötapausten mukaan, jonka jälkeen valitaan alan kirjallisuudesta sovelluskohteelle hyödyllisimmät tekniikat.

\subsection{Käyttötapaukset ja vaatimukset tietorakenteelle}\label{usecase}

Kolme yleistä käyttötapausta pistepilvien kanssa työskenneltäessä ovat mallintaminen, mittaaminen ja katselu, jotka asettavat erilaisia vaatimuksia pistepilviä käsittelevälle ja visualisoivalle Laitossuunnitteluohjelmistolle. Esitellään seuraavaksi käyttötapaukset ja niiden asettamat vaatimukset. 

\subtitle{Mallintaminen}
 Kun laitoksesta halutaan luoda ajantasalla oleva 3d-malli pistepilven avulla, täytyy se mallintaa suunnitteluohjelmiston käyttämäksi geometriaksi pistepilveä mukaillen. Lattiat ja seinät on tasoina helppo asettaa paikalleen, kuten myös suunnitteluohjelmiston komponenttikirjastosta löytyvät laitteet. Suurin työ on yleensä putkistoissa, ilmakanavissa ja kaapeliradoissa. Useat suunnitteluohjelmistot tarjoavat jonkinasteista automatisointia etenkin putkien reititykseen pistepilven päälle. Ohjelmisto voi automaattisesti tunnistaa pilvestä sylintereitä ja asettaa niiden päälle sopivia putkisto-osia. Vaihtoehtoisesti käyttäjä voi valita pilvestä muutamia pisteitä ja ohjelmisto laskee niiden perusteella putken pituuden ja halkaisijan ja asettaa oikean osan paikalleen. Mallinnustyö ja etenkin automaattiset muodontunnistusalgoritmit asettavat ohjelmistolle vaatimuksen tarkkuudesta. Laitossuunnitteluohjelmistossa käytetään yleensä millimetrejä perusyksikköinä, joten pistepilvessä ei saisi esiintyä senttimetrien virheitä.

Mallintamisessa tärkeässä roolissa on suunnittelijan käyttämät näkymät ja pistepiven rajaaminen. Yleensä suunnittelija käyttää muutamaa koordinaattiakselien suuntaista näkymää samanaikaisesti, jotta kursorin saa helposti oikeaan paikkaan. Näkymän syvyys asetetaan usein hyvin pieneksi, jotta mallista näkyisi vain kulloisenkin mallinnustyön vaatima pieni siivu. Myös pistepilveä voidaan rajata niin, että siitä näkyy vain tarpeellinen osa. Pistepilviä visualisoivan ohjelmiston tulisi siis kyetä rajaamaan pilveä toistuvasti ja nopeasti. Käyttökokemus olisi paras, jos käyttäjä pystyisi hiirellä interaktiivisesti määrittämään tilan, jonka sisäpuolella olevat pisteet visualisoitaisiin. Lisäksi pistepilvi tulee voida visualisoida useaan eri näkymään samanaikaisesti.

\subtitle{Mittaaminen}
Toinen tärkeä ominaisuus pistepilvien kanssa työskennellessä on mittaaminen. Pistepilviä käytetään usein tarkastamaan, mahtuuko laitokseen jokin uusi laite tai putkisto. Tällöin on hyödyllistä suorittaa mittauksia joko kahden pistepilven pisteen, tai pisteen ja 3d-mallin geometrian välillä. Mittausoperaatiossa käyttäjä valitsee pistepilvestä kursorilla haluamansa pisteen ja ohjelmisto palauttaa lähimmäksi kursoria projisoidun pisteen. Käyttäjän kannalta olisi miellyttävää, jos mittausoperaatioita tehtäessä ei tarvitsisi odottaa, kun pistepilven miljoonien pisteiden joukosta etsitään juuri kursorin alla oleva piste. Yksittäisten pisteiden hakeminen pilvestä täytyy siis olla nopeaa.

\subtitle{Katselu}
Kolmas yleinen pistepilvien käyttökohde on 3d-mallin katselu joko laitossuunnitteluohjelmistossa tai erityisessä mallinkatseluohjelmistossa. Etenkin suunnitteluprojektien esimiehet haluavat usein tarkastella suunnittelijoiden luomaa 3d-mallia helposti ja nopeasti. Luonnollisesti malliin kuuluvat pistepilvet tulevat myös näkyä katselijalle. Tämä saattaa tuottaa haasteita ohjelmiston kannalta, sillä katseluohjelmistojen käyttäjillä on käytettävissä harvoin yhtä järeää laitteistoa, kuin suunnittelijoiden työasemat. Mallinkatseluohjelmistossa pistepilveä harvemmin rajataan pienemmäksi, joten visualisoitavia pisteitä on niin paljon, etteivät ne mahdu kerralla keskusmuistiin tai grafiikkaprosessorin muistiin. Yleensä käyttäjä myös liikuttaa näkymää mallin ympäri enemmän kuin mallinnustyössä, joten pistepilvivisualisoinnin suorituskyky ja tarkkuustasot ovat entistäkin tärkeämpiä.

Tässä tutkielmassa kehitetään laitossuunnitteluohjelmistolle optimoitu hierarkinen tietorakenne pistepilvien käsittelyyn. Esitetään tietorakenteelle seuraavat vaatimukset edellä mainittujen käyttötapausten perusteella:
\begin{enumerate}
    \item \label{vaatimus:lod} On voitava visualisoida karkea yleiskuva pistepilvestä vain pienellä osalla datasta. 
    \item \label{vaatimus:ooc} On käytettävä ulkoisen muistin algoritmeja, eli koko pilveä ei pidetä kerralla keskusmuistissa.
    \item \label{vaatimus:harvennus} Pistepilven vaatimaa tallennustilan määrää voidaan laskea harventamalla sen tiheästi näytteistettyjä osia. 
    \item \label{vaatimus:crop} Käyttäjän on voitava määrittää pilvestä alueita, joiden sisältävien tai ulkopuolelle jäävien pisteiden ominaisuuksia, kuten näkyvyyttä tai väriä, voidaan muuttaa.
    \item \label{vaatimus:select} Pilvestä on voitava nopeasti ja tarkasti valita yksittäisiä pisteitä.
    \item \label{vaatimus:virhe} Pistepilvessä ei saa esiintyä yli millimetrin suuruisia virheitä.
\end{enumerate}


\subsection{Tietorakenteen valinta}

Luvussa \ref{tietorakenteet} esitellyt sisäkkäispistepuut näyttävät soveltuvan hyvin laitossuunnitteluohjelmiston vaatimuksiin. Oktettipuun läpikäyminen taso kerrallaan muodostaa tehokkaasti tarkkuustasot, joten vaatimus \ref{vaatimus:lod} on helppo tyydyttää. Pisteiden asettelu sisäkkäisten oktettipuiden solmuihin mahdollistaa myös vaatimuksen \ref{vaatimus:ooc} mukaisesti ulkoisen muistin käyttämisen. Scheiblauerin muokattavien sisäkkäisten oktettipuiden jokainen solmu sisältää ruudukon, johon pisteet sijoitetaan. Mitä syvemmällä tasolla solmu on, sitä pienempiä ruudukon solut ovat. Vaatimuksen \ref{vaatimus:harvennus} esittämä pilven harvennus onnistuu asettamalla puulle enimmäissyvyys ruudukon koon mukaan ja hylkäämällä lehtisolmuissa kaikki pisteet, jotka tulisi lisätyksi jo varattuun soluun. 

Valintaoperaatiot onnistuvat nopeasti oktettipuussa. Puun jokainen solmu sisältää tiedon sen sisältämien pisteiden rajaavasta laatikosta, joten jos valinnan sijainti ei osu rajaavan laatikon sisälle, ei kyseisen solmun lapsisolmujakaan tarvitse tarkastaa. Yksittäisiä pisteitä tarvitsee tarkastella vasta kun valittavan alueen raja kulkee puun solmun rajaavan laatikon läpi, tai kun käyttäjä haluaa valita vain yhden pisteen. Tietyllä aluella sijaitsevat pisteet jakautuvat useaan oktettipuun solmuun, minkä johdosta valintaoperaatiot eivät ole triviaaleja sisäkkäisissä oktettipuissa. Vaatimuksiin \ref{vaatimus:crop} ja \ref{vaatimus:select} voidaan kuitenkin vastata sisäkkäisillä oktettipuilla. Scheiblauer ja Schütz eivät tiivistäneet pistepilviä, joten niiden tarkkuus ei kärsinyt. Näin myöskään vaatimus \ref{vaatimus:virhe} ei tuota ongelmia.


\subsection{Ruudukko}
\begin{figure}
    \begin{tikzpicture}[every node/.style={minimum size=1cm},on grid]
        \begin{scope}[every node/.append style={yslant=-0.5},yslant=-0.5]
        \shade[right color=lightgray!10, left color=gray!40] (0,0) rectangle +(4,4);
        \node at (0.5,3.5) {12};
        \node at (1.5,3.5) {13};
        \node at (2.5,3.5) {14};
        \node at (3.5,3.5) {15};
        
        \node at (0.5,2.5) {8};
        \node at (1.5,2.5) {9};
        \node at (2.5,2.5) {10};
        \node at (3.5,2.5) {11};
        
        \node at (0.5,1.5) {4};
        \node at (1.5,1.5) {5};
        \node at (2.5,1.5) {6};
        \node at (3.5,1.5) {7};
        
        \node at (0.5,0.5) {0};
        \node at (1.5,0.5) {1};
        \node at (2.5,0.5) {2};
        \node at (3.5,0.5) {3};
        \draw (0,0) grid (4,4);
        \end{scope}

        \begin{scope}[every node/.append style={yslant=0.5},yslant=0.5]
        \shade[right color=gray!40,left color=lightgray!10] (4,-4) rectangle +(4,4);
        \node at (4.5,-0.5) {15};
        \node at (5.5,-0.5) {31};
        \node at (6.5,-0.5) {47};
        \node at (7.5,-0.5) {63};
        
        \node at (4.5,-1.5) {11};
        \node at (5.5,-1.5) {27};
        \node at (6.5,-1.5) {43};
        \node at (7.5,-1.5) {59};
        
        \node at (4.5,-2.5) {7};
        \node at (5.5,-2.5) {23};
        \node at (6.5,-2.5) {39};
        \node at (7.5,-2.5) {55};
        
        \node at (4.5,-3.5) {3};
        \node at (5.5,-3.5) {19};
        \node at (6.5,-3.5) {35};
        \node at (7.5,-3.5) {51};
        
        \draw (4,-4) grid (8,0);
        \end{scope}
        \begin{scope}[every node/.append style={
            yslant=0.5,xslant=-1},yslant=0.5,xslant=-1
        ]
        \shade[bottom color=white, top color=white] (8,4) rectangle +(-4,-4);
        \node at (4.5,3.5) {12};
        \node at (4.5,2.5) {13};
        \node at (4.5,1.5) {14};
        \node at (4.5,0.5) {15};
        
        \node at (5.5,3.5) {28};
        \node at (5.5,2.5) {29};
        \node at (5.5,1.5) {30};
        \node at (5.5,0.5) {31};
        
        \node at (6.5,3.5) {44};
        \node at (6.5,2.5) {45};
        \node at (6.5,1.5) {46};
        \node at (6.5,0.5) {47};
        
        \node at (7.5,3.5) {60};
        \node at (7.5,2.5) {61};
        \node at (7.5,1.5) {61};
        \node at (7.5,0.5) {63};
        
        \draw (4,0) grid (8,4);
        \end{scope}

        \begin{scope}{
            \draw[->,thick, color=red] (-2,-0.0) -- (-1.0,-0.5);
            \draw[->,thick, color=green] (-2,-0.0) -- (-2,1.2);
            \draw[->,thick, color=blue] (-2,-0.0) -- (-1.0,0.5);
            \draw (-0.7,-0.7) node {$x$};
            \draw (-2,1.5) node {$y$};
            \draw (-0.8,0.7) node {$z$};
        }
        \end{scope}
    \end{tikzpicture}
    \caption{64:n solun ruudukko}
    \label{ruudukkokuva}
\end{figure}

\subsection{Pisteiden valinta}

\subsection{Visualisointi}
%Scheiblauer esittää väitöskirjassaan sisäkkäisille muokattaville oktettipuille erityistä tietorakennetta pisteiden valintaan. Scheiblauer määrittää jokaista valittavaa tilaa kohti uuden oktettipuun, jonka ...